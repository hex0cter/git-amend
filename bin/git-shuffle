#!/usr/bin/env ruby

require 'timerizer'
require 'time'
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: date-shuffle [options]"

  opts.on("-p path", "--path=path", "Path to the target respository") do |path|
    options[:path] = path
  end
end.parse!

if options[:path] == nil
  puts 'Using current directory...'
  options[:path] = Dir.pwd
end

Dir.chdir options[:path]

spread_factor = 4 # 1 commit every 4 days in average

no_of_all_commits = %x(git log --pretty=format:"%H" | wc -w)
no_of_all_commits = no_of_all_commits.to_i
development_days_for_repo = no_of_all_commits * spread_factor
puts "Spreading #{no_of_all_commits} commits into #{development_days_for_repo} days."

days_offset = []
(1..development_days_for_repo).to_a.sample(no_of_all_commits).each do |num|
  days_offset << num
end

days_offset.sort!

index = 0

days_offset.each do |offset|
  index += 1

  commit_hash = %x(git log -#{index} --pretty=format:"%H" | tail -1)

  date = offset.days.ago
  new_time = Time.new(date.year, date.month, date.day, (18..23).to_a.sample, (0..59).to_a.sample, (0..59).to_a.sample, "+02:00").to_s
  puts "[#{index}/#{no_of_all_commits}] Set commit #{commit_hash} to #{offset} days ago: #{new_time}"

  command = <<-FOO
  git filter-branch -f --env-filter "if test \\$GIT_COMMIT = \'#{commit_hash}\' ; then export GIT_AUTHOR_DATE='#{new_time}'; export GIT_COMMITTER_DATE='#{new_time}'; fi && rm -fr '.git/refs/original/'"
FOO
  system(command)
end
